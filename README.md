# symbolノード監視SpreadSheet

## 概要
Symbolブロックチェーンのdualノードに定期的にリクエストを送って、ノードの状態を監視する。
異常があったら通知するためのスプレッドシートおよびGASスクリプトのプロジェクト。

## スプレッドシートの概要

TSVでシートを貼り付けたのがこちら

```
ノード監視シート		基準ブロック高	1,670,000		ブロックしきい値	5			
									
	ノードURL	Status	ErrorType	DB	API	BlockHeight	エラー発生日時	エラー最終通知日時	エラー詳細
	https://vmi2764990.contaboserver.net:3001	Running		up	up	1,670,000	2025/08/29 17:20:20	2025/08/29 17:20:20	
```

### 仕様

1行目はメタ的なデータを扱う。

- A1: タイトルラベル
- B1: 基準ブロック高(ラベル)
- C1: ブロック高
	- 数式: `=max(G4:G)`
- F1: ブロック高しきい値(ラベル)
- G1: ブロックしきい値(整数値)
	- ブロック遅延エラーの閾値として使う。手動入力。

3行目より実際に監視するノードやステータスを管理する。
  ※3行目はヘッダなので実データはB4から

- B列:ノードURL(文字列)
  - 値例: `https://vmi2764990.contaboserver.net:3001`
- C列: ステータス(プルダウン)
	- 値: Running | Error | Delay
- D列: エラータイプ(文字列)
  - 後述するエラータイプを記載する。正常時は空白。
- E列: DB(プルダウン)
  - APIからの戻り値を記載
- F列: API(プルダウン)
  - APIからの戻り値を記載
- G列: ブロック高(整数値)
  - APIからの戻り値を記載
- H列: エラー発生日時(日時)
  - 最初にエラーを検知した日時。正常に戻ったらクリア。
- I列: エラー最終通知日時(日時)
  - 最後にそのエラーを通知した日時。正常に戻ったらクリア。再度通知を行ったら更新
- J列: 無効（プルダウン）
  - 値: 無効 | (空白)
  - 無効に設定されている行はエラーチェック・通知とも対象外とする


## 通知
- 基本はGASに紐づくGoogleアカウントのメールアドレスに送る。
	- アドレスが自動取得できない場合はプロパティストアから入手する。
- Slack通知も有効にする
	- トークンやチャンネルIDなどはプロパティストアから入手する。
	- 一つでも未入力だった場合、エラーにはせずただ通知をスキップする

## 起動方法
- GASのinstallable triggerにてエントリーポイントとなるメソッドを5分置きにキックする

## スクリプト仕様
このセクションが実際に実装してもらうGASの仕様となります。

### 事前準備
- プロパティストアから通知先情報を取得する
- スプレッドシートから監視対象ノードを取得する。
  - シート名は`mainnet`と`testnet`。mainnetは通知するが、testnetはステータスの取得とスプレッドシートへの更新だけで通知しない。
  - スプレッドシートセクションに記載の通り、B4セルからがデータ及び更新先となる。
	- B4セル以降の行にデータが有るものを監視対象とする。

### 監視処理
#### 共通
- エラー判定された場合、該当行のH列にシステム日時を設定する。
- H列に日時が設定されているもののすべてのチェックをパスした場合はH列とI列の日時をクリアする

#### 死活チェック
- ノードのAPIをURLから5秒以上レスポンスが返らなれけばダウンとする。
 - CのステータスをErrorにする
 - D列にエラータイプ `Timeout` を設定する
 - E, F, G列をクリアする

#### DB/APIヘルスチェック
- `{ノードURL}/node/health`にGETリクエストを送る。
- 以下のレスポンスが返る

```json
{
    "status": {
        "apiNode": "up",
        "db": "up"
    }
}
```
- status.apiNodeがupであればAPIは正常。E列をupで更新
- status.dbがupであればDBは正常。F列をupで更新
- エラーの場合、D列は`DB/API`とする
- H列が空白であればシステム日時を設定する

### ブロック高取得
- `{ノードURL}/node/health`にGETリクエストを送る。
- 以下のレスポンスが返る

```json
{
    "height": "4680273",
    "scoreHigh": "31",
    "scoreLow": "9532475889597866100",
    "latestFinalizedBlock": {
        "finalizationEpoch": 3252,
        "finalizationPoint": 12,
        "height": "4680244",
        "hash": "13CBF4D40236E13CF3E4FF39AE100AA5641FC6998C4E591E9D8B7D152D6994F1"
    }
}
```

- G列にheightの値を数値にキャストして記録する。
- ここはブロック高の取得であり、後述するブロック遅延エラーの判定に使うだけなのでタイムアウト以外は何もしない。

### すべてのノードの取得が終わったら
#### ブロック遅延エラーチェック
- $D$1に全ノードで一番高いブロック高を表示される。
- $D$1と各ノードのG列を比較して、$G$1よりG列の値が$G$1-5より小さい場合は遅延とする。
- 遅延と判定された以下の処理を行う
 - C列のステータスをDelayにする
 - D列にエラータイプ `BlockDelay` を設定する
 - H列が空白であればシステム日時を設定する

#### 通知処理
- 以下をすべて満たすものが通知対象となる
  - C列のステータスがRunning以外のもの
	- I列の最終通知日時から30分が経過している

- GASの実行中に想定外のエラーが発生した場合は、エラー内容を通知する


## コーディングガイドライン
- 列は今後変更される可能性があるので、コードの先頭などに定数として宣言し、変更に強いコードを書く
- エントリーポイントとなるメソッドを最初に記載し、可読性が高まるようなメソッド分けをする
- claspは使用しない。手動でコピペでデプロイする。
- コードの先頭に`// @ts-check`と記載したいが、GAS標準のメソッドやクラスの呼び出しでエラーが出るようなら不要
